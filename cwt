# 워크트리 생성
source "${ZDOTDIR:-$HOME}/.zfunc/_cwt_init" || return 1

# 1) 워크트리 이름
local name="${1}"
if [[ -z "$name" ]]; then
  echo -n "워크트리 이름: "
  read name
  [[ -z "$name" ]] && echo "error: 이름은 필수입니다." >&2 && return 1
fi

local worktree_path="${_cwt_worktrees_dir}/${name}"
if [[ -d "$worktree_path" ]]; then
  echo "error: 이미 존재하는 워크트리입니다: $name" >&2
  return 1
fi

# 2) 베이스 브랜치 선택
local base_branch="${2}"
if [[ -z "$base_branch" ]]; then
  local branches=("HEAD" $(git -C "$_cwt_git_root" branch --format='%(refname:short)' 2>/dev/null))
  if command -v fzf &>/dev/null; then
    base_branch=$(printf '%s\n' "${branches[@]}" | fzf \
      --prompt="베이스 브랜치 > " \
      --height=40% \
      --border \
      --header="ESC: 취소  Enter: 선택")
    [[ -z "$base_branch" ]] && echo "취소되었습니다." && return 0
  else
    echo "베이스 브랜치:"
    local i=1
    for b in "${branches[@]}"; do
      echo "  $i) $b"
      ((i++))
    done
    echo -n "번호 선택 (기본값: 1=HEAD): "
    read num
    if [[ -z "$num" ]]; then
      base_branch="HEAD"
    elif [[ "$num" =~ ^[0-9]+$ ]] && (( num >= 1 && num <= ${#branches[@]} )); then
      base_branch="${branches[$num]}"
    else
      echo "error: 잘못된 선택입니다." >&2
      return 1
    fi
  fi
fi

# 3) 브랜치 이름 (자동 생성)
local branch_name="${3}"
if [[ -z "$branch_name" ]]; then
  local rand=$(LC_ALL=C tr -dc 'a-z0-9' < /dev/urandom | head -c 4)
  branch_name="wt/${name}-${rand}"
fi

# 4) worktree 생성
echo "워크트리 생성: $worktree_path (base: $base_branch, branch: $branch_name)"
git -C "$_cwt_git_root" worktree add -b "$branch_name" "$worktree_path" "$base_branch"
if [[ $? -ne 0 ]]; then
  echo "error: worktree 생성 실패" >&2
  return 1
fi

# 5) .worktreeinclude 처리
local include_file="${_cwt_git_root}/.worktreeinclude"
if [[ -f "$include_file" ]]; then
  echo ".worktreeinclude 처리 중..."
  while IFS= read -r pattern || [[ -n "$pattern" ]]; do
    [[ -z "$pattern" || "$pattern" == \#* ]] && continue
    local files=("${_cwt_git_root}"/${~pattern})
    for src in "${files[@]}"; do
      [[ ! -e "$src" ]] && continue
      local rel="${src#${_cwt_git_root}/}"
      local dst="${worktree_path}/${rel}"
      mkdir -p "$(dirname "$dst")"
      cp "$src" "$dst"
      echo "  복사: $rel"
    done
  done < "$include_file"
fi

echo ""
echo "완료: $name"
echo "  경로:   $worktree_path"
echo "  브랜치: $branch_name"
echo "  베이스: $base_branch"
echo ""

cd "$worktree_path" && claude

#compdef cwt
# ─────────────────────────────────────────────────────────────────────────────
# Zsh completion for cwt - AI Worktree Manager
# ─────────────────────────────────────────────────────────────────────────────

# Resolve the shared repository root (works in linked worktrees too).
(( $+functions[_cwt_repo_root] )) || _cwt_repo_root() {
  local current_root git_common_dir
  current_root=$(git rev-parse --show-toplevel 2>/dev/null) || return

  git_common_dir=$(git rev-parse --git-common-dir 2>/dev/null)
  if [[ -z "$git_common_dir" ]]; then
    echo "${current_root:A}"
    return
  fi

  if [[ "$git_common_dir" != /* ]]; then
    git_common_dir="${current_root}/${git_common_dir}"
  fi
  echo "${git_common_dir:A:h}"
}

# List existing worktree names from .worktrees/*/
(( $+functions[_cwt_worktree_names] )) || _cwt_worktree_names() {
  local git_root wt_dir
  git_root=$(_cwt_repo_root) || return

  if [[ -n "$CWT_WORKTREE_DIR" ]]; then
    wt_dir="$CWT_WORKTREE_DIR"
  else
    wt_dir="${git_root}/.worktrees"
  fi

  [[ -d "$wt_dir" ]] || return

  local -a names
  local d
  for d in "$wt_dir"/*(N/); do
    names+=("${d:t}")
  done
  (( ${#names} )) && compadd -X "worktrees" -a names
}

# List git branch names
(( $+functions[_cwt_branches] )) || _cwt_branches() {
  local git_root
  git_root=$(_cwt_repo_root) || return

  local -a branches
  branches=( ${(f)"$(git -C "$git_root" branch --format='%(refname:short)' 2>/dev/null)"} )
  (( ${#branches} )) && compadd -X "branches" -a branches
}

(( $+functions[_cwt_assistants] )) || _cwt_assistants() {
  compadd -X "assistants" claude codex gemini
}

_cwt_new() {
  _arguments -s \
    '(-h --help)'{-h,--help}'[Show help]' \
    '--assistant[Assistant to launch]:assistant:_cwt_assistants' \
    '--claude[Shortcut for --assistant claude]' \
    '--codex[Shortcut for --assistant codex]' \
    '--gemini[Shortcut for --assistant gemini]' \
    '--no-launch[Skip assistant launch after creation]' \
    ':name:' \
    ':base-branch:_cwt_branches' \
    ':branch-name:'
}

_cwt_ls() {
  _arguments -s \
    '(-h --help)'{-h,--help}'[Show help]'
}

_cwt_cd() {
  _arguments -s \
    '(-h --help)'{-h,--help}'[Show help]' \
    '--assistant[Assistant to launch]:assistant:_cwt_assistants' \
    '--claude[Shortcut for --assistant claude]' \
    '--codex[Shortcut for --assistant codex]' \
    '--gemini[Shortcut for --assistant gemini]' \
    ':name:_cwt_worktree_names'
}

_cwt_rm() {
  _arguments -s \
    '(-h --help)'{-h,--help}'[Show help]' \
    '(-f --force)'{-f,--force}'[Skip confirmation prompt]' \
    ':name:_cwt_worktree_names'
}

_cwt_update() {
  _arguments -s \
    '(-h --help)'{-h,--help}'[Show help]'
}

_cwt() {
  local -a commands
  commands=(
    'new:Create a new worktree and launch an assistant'
    'ls:List all worktrees with status'
    'cd:Enter an existing worktree'
    'rm:Remove a worktree'
    'update:Self-update cwt'
  )

  _arguments -s \
    '(-q --quiet)'{-q,--quiet}'[Suppress informational messages]' \
    '(-h --help)'{-h,--help}'[Show help]' \
    '(-v --version)'{-v,--version}'[Show version]' \
    '1:command:->command' \
    '*::args:->args'

  case "$state" in
    command)
      _describe -t commands 'cwt command' commands
      ;;
    args)
      case "$words[1]" in
        new)    _cwt_new    ;;
        ls)     _cwt_ls     ;;
        cd)     _cwt_cd     ;;
        rm)     _cwt_rm     ;;
        update) _cwt_update ;;
      esac
      ;;
  esac
}

_cwt "$@"
